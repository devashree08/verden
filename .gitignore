"""
Input JSON Schemas for MCP tools (single source of truth).

Important:
- Clients NEVER send `email`. The server extracts it from the OIDC JWT.
- `vast` may be CSV ("101,202") or an array ([101, 202]); we normalize to CSV.
- `report_month` accepts "YYYY-MM" or "Month YYYY" (e.g., "February 2024");
  we normalize to the literal "YYYY-MM-01 00:00:00" (no timezone math).
- Pagination: limit default 1000, cap 15000; offset default 0.
"""

# Common $defs reused by all schemas. Keep inline to avoid extra files.
COMMON_DEFS = {
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "urn:schemas:mcp:common",
    "$defs": {
        "vastCsv": {
            "type": "string",
            "title": "VAST IDs (CSV)",
            "description": "Comma-separated VAST IDs, e.g., '101,202,303'. Whitespace allowed.",
            "pattern": r"^\s*\d+\s*(\s*,\s*\d+\s*)*$",
            "examples": ["101,202,303"],
        },
        "vastArray": {
            "type": "array",
            "title": "VAST IDs (Array)",
            "description": "Array of VAST IDs; will be normalized to CSV internally.",
            "items": {
                "oneOf": [
                    {"type": "integer", "minimum": 0},
                    {"type": "string", "pattern": r"^\d+$"},
                ]
            },
            "examples": [[101, 202, 303]],
        },
        "vast": {
            "title": "VAST IDs",
            "description": (
                "Optional filter to specific VAST IDs. Accepts CSV string or array. "
                "If omitted or empty, no VAST filter is applied."
            ),
            "oneOf": [{"$ref": "#/$defs/vastCsv"}, {"$ref": "#/$defs/vastArray"}],
        },
        "limit": {
            "type": "integer",
            "title": "Limit",
            "minimum": 1,
            "maximum": 15000,
            "default": 1000,
            "description": "Maximum rows to return (1–15000). Default 1000.",
        },
        "offset": {
            "type": "integer",
            "title": "Offset",
            "minimum": 0,
            "default": 0,
            "description": "Rows to skip before returning results. Default 0.",
        },
        "reportMonth": {
            "type": "string",
            "title": "Report Month",
            "description": (
                "Target month to query. Accepts 'YYYY-MM' (e.g., '2024-02') or natural language like "
                "'February 2024'. Normalized to 'YYYY-MM-01 00:00:00' before querying."
            ),
            "examples": ["2024-02", "February 2024", "2024-02-01 00:00:00"],
        },
    },
}

GET_ALL_APPS_VALUE_BY_USER = {
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "title": "get_all_apps_value_by_user Input",
    "type": "object",
    "additionalProperties": False,
    "description": (
        "Current month (daily snapshot) rows for the caller. "
        "Email is extracted from the bearer token; clients must not supply it."
    ),
    "properties": {
        "vast": {"$ref": "urn:schemas:mcp:common#/$defs/vast"},
        "limit": {"$ref": "urn:schemas:mcp:common#/$defs/limit"},
        "offset": {"$ref": "urn:schemas:mcp:common#/$defs/offset"},
    },
}

GET_ALL_APPS_SUMMARY_BY_USER = {
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "title": "get_all_apps_summary_by_user Input",
    "type": "object",
    "additionalProperties": False,
    "description": (
        "Monthly snapshot rows for the caller; includes historical months. "
        "Email is extracted from the bearer token."
    ),
    "properties": {
        "vast": {"$ref": "urn:schemas:mcp:common#/$defs/vast"},
        "report_month": {"$ref": "urn:schemas:mcp:common#/$defs/reportMonth"},
        "limit": {"$ref": "urn:schemas:mcp:common#/$defs/limit"},
        "offset": {"$ref": "urn:schemas:mcp:common#/$defs/offset"},
    },
}

GET_VAST_GENERAL_BY_USER = {
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "title": "get_vast_general_by_user Input",
    "type": "object",
    "additionalProperties": False,
    "description": (
        "Compliance/general details for the caller (includes decommissioned VASTs). "
        "Email is extracted from the bearer token."
    ),
    "properties": {
        "vast": {"$ref": "urn:schemas:mcp:common#/$defs/vast"},
        "limit": {"$ref": "urn:schemas:mcp:common#/$defs/limit"},
        "offset": {"$ref": "urn:schemas:mcp:common#/$defs/offset"},
    },
}

"""
Output JSON Schema for all MCP tools.

All tools return a uniform shape:
{
  "rows": [ { /* flat columns per row (300–400+) */ } ]
}
"""

ROWS_OUTPUT = {
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "title": "Standard Rows Output",
    "type": "object",
    "required": ["rows"],
    "additionalProperties": False,
    "properties": {
        "rows": {
            "type": "array",
            "description": "Result set rows. Each item is a flat object keyed by column name.",
            "items": {
                "type": "object",
                "additionalProperties": {
                    "description": "Column value",
                    "anyOf": [
                        {"type": "string"},
                        {"type": "integer"},
                        {"type": "number"},
                        {"type": "boolean"},
                        {"type": "null"},
                    ],
                },
            },
        }
    },
}


