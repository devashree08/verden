External triggers

SIEM/EDR alert, Dataflow batch-done, schedule, or analyst click → Apigee.

1) External trigger hits Apigee (API edge)

Apigee VerifyJWT (OIDC), strips spoofed headers, issues a request_id.

2) MCP Server (gateway/broker) – initiate task

First stop after Apigee.

Caller asks to run a tool (e.g., “Read Vulns” or “Triage Agent”).

MCP server owns the tool catalog.

3) Zero-Trust Authorization request (policy gate)

MCP server evaluates who/what/why:

identity: eid, groups

scope: allowed appIds, action (read/triage/validate)

context: time, source, rate caps, kill-switch

Default deny unless all checks pass.

4) Issue JIT credential (delegation token)

If allowed, MCP server mints a short-lived, signed token (e.g., JWT/JWS) with:

sub=eid, apps=[…], purpose, audience=<target tool/agent>, exp≤5m, nonce, request_id.

This is the “Just-In-Time” credential from the diagram.

5) Execute action (least-privilege)

MCP server calls the target tool/agent and passes the JIT token.

Read Vulns tool → BigQuery (authorized view + RLS)

Triage Agent (as a tool) → uses rules + Gemini (text only) →
JIRA Upsert tool (idempotent by payload_hash) → JIRA

Each tool validates the JIT token (audience/scope/expiry) before acting.

6) Log transaction (end-to-end auditing)

Every hop writes an audit line (with the same request_id) to BigQuery audit tables:

edge_audit (Apigee)

mcp_audit (allow/deny + scope)

triage_audit / validation_audit (actions/outcomes)

Tiny diagram (matches your boss’s boxes)
[External Triggers] ──► (1) [Apigee Edge]
                           │ VerifyJWT + request_id
                           ▼
                     (2) [MCP Server / Gateway]
                           │
                           │ (3) Zero-Trust Policy Gate
                           │     (eid, groups → apps, purpose, caps)
                           ▼
                     (4) Issue JIT Credential (short-lived signed token)
                           │
                           ├──► (5a) Tool: Read Vulns ──► BigQuery (RLS)
                           │
                           └──► (5b) Tool: Triage Agent (MCP “agent-as-tool”)
                                   └──► Tool: JIRA Upsert ──► JIRA (idempotent)
                           
(6) Logs from all hops ─────────► BigQuery audit tables (edge/mcp/triage/validation)
