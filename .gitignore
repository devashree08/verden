/* Generate C# DTO properties from a stored procedure's first result set
   SQL Server 2019+ using sys.dm_exec_describe_first_result_set_for_object
*/
DECLARE @ProcName sysname = N'dbo.spGetAllApps';  -- your proc
DECLARE @UseNullableRefTypes bit = 1;             -- string? / byte[]? when column is nullable

IF OBJECT_ID('tempdb..#meta') IS NOT NULL DROP TABLE #meta;
CREATE TABLE #meta (
    is_hidden bit,
    column_ordinal int,
    name sysname,
    is_nullable bit,
    system_type_id int,
    system_type_name nvarchar(256),
    max_length int,
    precision tinyint,
    scale tinyint,
    collation_name sysname NULL
);

-- Use the DMF (table-valued function) â€” NOT an sp_ proc:
INSERT INTO #meta
SELECT *
FROM sys.dm_exec_describe_first_result_set_for_object(
         OBJECT_ID(@ProcName),
         1 -- include_browse_information
     );

WITH base AS (
    SELECT
        column_ordinal,
        name AS ColumnName,
        is_nullable,
        -- strip "(...)" to get the base SQL type
        LOWER(LEFT(system_type_name, NULLIF(CHARINDEX('(', system_type_name + '(') - 1, -1))) AS base_sql_type,
        system_type_name
    FROM #meta
    WHERE is_hidden = 0
),
mapped AS (
    SELECT
        column_ordinal, ColumnName, is_nullable, base_sql_type, system_type_name,
        CASE base_sql_type
            WHEN 'bigint'           THEN 'long'
            WHEN 'int'              THEN 'int'
            WHEN 'smallint'         THEN 'short'
            WHEN 'tinyint'          THEN 'byte'
            WHEN 'bit'              THEN 'bool'
            WHEN 'decimal'          THEN 'decimal'
            WHEN 'numeric'          THEN 'decimal'
            WHEN 'money'            THEN 'decimal'
            WHEN 'smallmoney'       THEN 'decimal'
            WHEN 'float'            THEN 'double'
            WHEN 'real'             THEN 'float'
            WHEN 'datetime'         THEN 'DateTime'
            WHEN 'smalldatetime'    THEN 'DateTime'
            WHEN 'datetime2'        THEN 'DateTime'
            WHEN 'date'             THEN 'DateTime'
            WHEN 'time'             THEN 'TimeSpan'
            WHEN 'datetimeoffset'   THEN 'DateTimeOffset'
            WHEN 'uniqueidentifier' THEN 'Guid'
            WHEN 'binary'           THEN 'byte[]'
            WHEN 'varbinary'        THEN 'byte[]'
            WHEN 'image'            THEN 'byte[]'
            WHEN 'rowversion'       THEN 'byte[]'
            WHEN 'timestamp'        THEN 'byte[]'
            WHEN 'xml'              THEN 'string'
            WHEN 'char'             THEN 'string'
            WHEN 'nchar'            THEN 'string'
            WHEN 'varchar'          THEN 'string'
            WHEN 'nvarchar'         THEN 'string'
            WHEN 'text'             THEN 'string'
            WHEN 'ntext'            THEN 'string'
            WHEN 'sql_variant'      THEN 'object'
            WHEN 'geometry'         THEN 'object'
            WHEN 'geography'        THEN 'object'
            WHEN 'hierarchyid'      THEN 'object'
            ELSE 'object'
        END AS CSharpBaseType
    FROM base
)
SELECT
    'public '
    + CSharpBaseType
    + CASE
        -- nullable value types -> ?
        WHEN CSharpBaseType IN ('long','int','short','byte','bool','decimal','double','float','DateTime','TimeSpan','DateTimeOffset','Guid')
             AND is_nullable = 1 THEN '?'
        -- reference/array types get ? only if you opt in and column is nullable
        WHEN CSharpBaseType IN ('string','byte[]','object') AND @UseNullableRefTypes = 1 AND is_nullable = 1 THEN '?'
        ELSE ''
      END
    + ' '
    + QUOTENAME(ColumnName)  -- keep if you have spaces/keywords; remove to get bare identifiers
    + ' { get; set; }' AS DTO_Line
FROM mapped
ORDER BY column_ordinal;
