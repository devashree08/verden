CREATE OR ALTER PROCEDURE dbo.usp_AuthorizeOrgWrite
  @OrgID         INT,
  @ActorEID      NVARCHAR(64)    = NULL,
  @ActorUserName NVARCHAR(256)   = NULL
AS
BEGIN
  SET NOCOUNT ON;

  IF @ActorEID IS NULL AND @ActorUserName IS NULL
    THROW 51020, 'Actor identity required.', 1;

  -- Load policy names for this actor (Admin, Edit.<OrgCode>.All, etc.)
  CREATE TABLE #pol (PolicyName NVARCHAR(128) NOT NULL);
  INSERT INTO #pol(PolicyName)
    EXEC dbo.usp_PortalPolicies_GetForUser
         @UserEID  = @ActorEID,
         @UserName = @ActorUserName;

  -- Admin can edit all orgs
  IF EXISTS (SELECT 1 FROM #pol WHERE PolicyName = 'Admin')
    RETURN;

  -- Otherwise, the actor must have a matching Edit.<OrgCode>.All for the given OrgID
  IF NOT EXISTS (
      SELECT 1
      FROM #pol p
      JOIN dbo.Portal_OrgMap om
        ON ('Edit.' + om.OrgCode + '.All') = p.PolicyName
      WHERE om.OrgId = @OrgID
  )
    THROW 51021, 'Forbidden: not authorized to edit this Org.', 1;
END
GO
