   DECLARE @EffectiveUserId NVARCHAR(64);
    DECLARE @eid_count INT;

    SELECT
        @EffectiveUserId = CAST(MIN(wf.identityeid) AS NVARCHAR(64)),  -- deterministic pick
        @eid_count       = COUNT(DISTINCT wf.identityeid)
    FROM [database].[datastore].[dbo].[workersfeed] AS wf
    WHERE LTRIM(RTRIM(wf.emailaddressinternal)) = @Email;  -- case-insensitive under most collations

    IF @eid_count IS NULL OR @eid_count = 0
        THROW 50002, 'Email not found in workersfeed', 1;

    IF @eid_count > 1
        THROW 50003, 'Email maps to multiple EIDs in workersfeed', 1;
