"""
Tool: get_all_apps_value_by_user  -> dbo.SPGetAllAppsValueByUser
- Current-month, daily snapshot
- Optional VAST filter (CSV or array)
"""

from __future__ import annotations
from typing import Any, Dict, List, Optional, Union

from fastmcp import Context
from framework.core.registry import mcp
from framework.core.config import DB_BACKEND
from framework.schemas.inputs import GET_ALL_APPS_VALUE_BY_USER
from framework.schemas.outputs import ROWS_OUTPUT


@mcp.tool(
    name="get_all_apps_value_by_user",
    description=(
        "Return current-month application vulnerability counts for the caller's accessible VASTs. "
        "Optionally filter by VAST IDs."
    ),
    input_schema=GET_ALL_APPS_VALUE_BY_USER,
    output_schema=ROWS_OUTPUT,
)
async def get_all_apps_value_by_user(
    vast: Optional[Union[str, List[Union[int, str]]]] = None,
    limit: int = 1000,
    offset: int = 0,
    ctx: Context = Context.depends(),
) -> Dict[str, List[Dict[str, Any]]]:
    email = (ctx.get_state("email") or "").lower()

    if DB_BACKEND == "mssql":
        from framework.adapters.mssql import call_sp_allapps_value as run_query
        rows = run_query(email=email, vast=vast, limit=limit, offset=offset)
    else:
        from framework.adapters.bigquery import query_allapps_value as run_query
        rows = run_query(email=email, vast=vast, limit=limit, offset=offset)

    return {"rows": rows}
