-- Assumes staging table:
-- stg.TPD_CSF2_Custom(CSF2SubcategoryName NVARCHAR(200), MaturityLevel TINYINT, AttributeDefinition NVARCHAR(500))

BEGIN TRAN;

;WITH file_rows AS (
  SELECT DISTINCT
         LTRIM(RTRIM(s.CSF2SubcategoryName)) AS CSF2SubcategoryName,
         s.MaturityLevel,
         LTRIM(RTRIM(s.AttributeDefinition))  AS Definition
  FROM stg.TPD_CSF2_Custom s
),
resolved AS (
  SELECT
    OrgID          = 4,
    sc.SubcategoryID AS CSF2SubcatID,
    f.MaturityLevel,
    f.Definition
  FROM file_rows f
  JOIN ref.CSF2_Subcategory sc
    ON sc.SubcategoryName = f.CSF2SubcategoryName
),
existing_max AS (
  SELECT
    CSF2SubcatID,
    MaturityLevel,
    MAX(AttributeNum) AS maxNum
  FROM dbo.Org_CustomCsf2Attribute
  WHERE OrgID = 4 AND IsActive = 1
  GROUP BY CSF2SubcatID, MaturityLevel
),
numbered AS (
  SELECT
    r.OrgID,
    r.CSF2SubcatID,
    r.MaturityLevel,
    r.Definition,
    baseNum = CASE WHEN ISNULL(em.maxNum,0) < 15 THEN 14 ELSE em.maxNum END,
    rn      = ROW_NUMBER() OVER (PARTITION BY r.CSF2SubcatID, r.MaturityLevel ORDER BY (SELECT 1))
  FROM resolved r
  LEFT JOIN existing_max em
    ON em.CSF2SubcatID = r.CSF2SubcatID
   AND em.MaturityLevel = r.MaturityLevel
)
INSERT dbo.Org_CustomCsf2Attribute
  (OrgID, CSF2SubcatID, MaturityLevel, AttributeNum, Definition,
   Attestation2025, IsActive, CreatedBy, ModifiedBy)
SELECT
  OrgID,
  CSF2SubcatID,
  MaturityLevel,
  baseNum + rn       AS AttributeNum,   -- first new number is â‰¥ 15 and continues from current max
  Definition,
  NULL               AS Attestation2025,
  1                  AS IsActive,
  N'TPD Initial Load',
  N'TPD Initial Load'
FROM numbered;

COMMIT;
