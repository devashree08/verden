import * as React from "react";
import { useMemo, useState, useRef, useEffect } from "react";
import {
  CssBaseline,
  Container,
  Box,
  Grid,
  Card,
  CardContent,
  Typography,
  Button,
  ButtonGroup,
  Stack,
  TextField,
  Switch,
  FormControlLabel,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Chip,
  Tabs,
  Tab,
  Divider,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  List,
  ListItemButton,
  ListItemText,
  IconButton,
  Avatar,
  LinearProgress,
  Paper
} from "@mui/material";
import ExpandMoreIcon from "@mui/icons-material/ExpandMore";
import VisibilityIcon from "@mui/icons-material/Visibility";
import PictureAsPdfIcon from "@mui/icons-material/PictureAsPdf";
import DescriptionIcon from "@mui/icons-material/Description";
import PsychologyIcon from "@mui/icons-material/Psychology";
import SendIcon from "@mui/icons-material/Send";
import ContentCopyIcon from "@mui/icons-material/ContentCopy";
import TaskAltIcon from "@mui/icons-material/TaskAlt";
import AddLinkIcon from "@mui/icons-material/AddLink";
import EditIcon from "@mui/icons-material/Edit";
import ClearAllIcon from "@mui/icons-material/ClearAll";
import CloseIcon from "@mui/icons-material/Close";

// ---------- CSF 2.0 realistic test data ----------
const SUBCATS = [
  "GV.RR-01",
  "PR.AA-01",
  "PR.AT-01",
  "PR.DS-01",
  "PR.PS-01",
  "DE.AE-02",
  "DE.AE-03",
  "RS.MI-01",
  "RC.RP-01",
  "ID.IM-01",
];

const DEFINITIONS = {
  "GV.RR-01":
    "Organizational leadership is responsible and accountable for cybersecurity risk and fosters a risk-aware, ethical, continually improving culture.",
  "PR.AA-01":
    "Identities and credentials for authorized users, services, and hardware are managed by the organization.",
  "PR.AT-01":
    "Personnel receive awareness and training to perform general tasks with cyber risks in mind.",
  "PR.DS-01":
    "Data-at-rest is protected (confidentiality, integrity, availability).",
  "PR.PS-01": "Configuration management practices are established and applied.",
  "DE.AE-02":
    "Potentially adverse events are analyzed to better understand associated activities.",
  "DE.AE-03": "Information is correlated from multiple sources.",
  "RS.MI-01": "Incidents are contained.",
  "RC.RP-01":
    "Recovery portion of the incident response plan is executed once initiated from the incident response process.",
  "ID.IM-01": "Improvements are identified from evaluations.",
};

const makeArtifacts = (count, sc, lvl) =>
  Array.from({ length: count }, (_, i) => ({
    id: `${sc}-${lvl}-A${i + 1}`,
    title: `Artifact ${i + 1} for ${sc}`,
    url: `https://example.com/artifacts/${encodeURIComponent(sc)}/${lvl}/${i + 1}`,
  }));

const MATURITY = {};
SUBCATS.forEach((sc) => {
  MATURITY[sc] = {
    L3: [
      {
        id: `${sc}-L3-1`,
        title: "Attribute 1",
        definition: `${DEFINITIONS[sc]} (baseline L3).`,
        artifacts: makeArtifacts(2, sc, "L3"),
      },
      {
        id: `${sc}-L3-2`,
        title: "Attribute 2",
        definition: `Documented process, periodic review, and stakeholder visibility for ${sc}.`,
        artifacts: makeArtifacts(2, sc, "L3"),
      },
    ],
    L4: [
      {
        id: `${sc}-L4-1`,
        title: "Attribute 1",
        definition: `Metrics-driven continuous improvement & automation for ${sc}.`,
        artifacts: makeArtifacts(3, sc, "L4"),
      },
      {
        id: `${sc}-L4-2`,
        title: "Attribute 2",
        definition: `Proactive validation and governance for ${sc}.`,
        artifacts: makeArtifacts(2, sc, "L4"),
      },
      {
        id: `${sc}-L4-3`,
        title: "Attribute 3",
        definition: `Integrated with enterprise risk metrics & assurance for ${sc}.`,
        artifacts: makeArtifacts(2, sc, "L4"),
      },
    ],
  };
});

const DB = { orgs: ["VCS", "VGS-T", "Network", "TPD"], subcategories: SUBCATS, maturity: MATURITY };

// ---------- Helpers ----------
function MultiSelect({ label, options, value, onChange }) {
  return (
    <FormControl fullWidth size="small">
      <InputLabel id={`${label}-label`}>{label}</InputLabel>
      <Select
        labelId={`${label}-label`}
        multiple
        value={value}
        onChange={(e) => onChange(e.target.value)}
        label={label}
        renderValue={(sel) => (
          <Box sx={{ display: "flex", flexWrap: "wrap", gap: 0.5 }}>
            {sel.map((v) => (
              <Chip key={v} label={v} size="small" />
            ))}
          </Box>
        )}
      >
        {options.map((opt) => (
          <MenuItem key={opt} value={opt}>
            {opt}
          </MenuItem>
        ))}
      </Select>
    </FormControl>
  );
}

// ---------- Mock Crew Agent call (swap with your API later) ----------
async function callAgentAPI({ agent, prompt, target }) {
  await new Promise((r) => setTimeout(r, 900));
  const score = Math.round(70 + Math.random() * 30); // 70–100
  return {
    agent,
    score,
    text:
      target?.type === "attribute"
        ? `Suggested comment for ${target.subcat} ${target.level} • ${target.title}:\n- Align artifacts to acceptance criteria.\n- Add evidence of periodic review.\n- Note exceptions and compensating controls.`
        : `Draft improvement:\n- Summarize stakeholder outcomes.\n- Highlight L3→L4 roadmap.\n- Include KPIs, cadence, and artifact review.`,
    usage: { tokens: 642, ms: 900 },
  };
}

// ---------- Attribute block with per-attribute AI + artifact edit ----------
function AttributeBlock({
  sc,
  level,
  attr,
  comment,
  onChangeComment,
  artifacts,
  onAddArtifact,
  onEditArtifact,
  onAskAI,
}) {
  const [adding, setAdding] = useState(false);
  const [newTitle, setNewTitle] = useState("");
  const [newUrl, setNewUrl] = useState("");

  return (
    <Accordion disableGutters>
      <AccordionSummary expandIcon={<ExpandMoreIcon />} sx={{ px: 1 }}>
        <Stack spacing={0.25} sx={{ pr: 1 }}>
          <Typography fontWeight={600}>{attr.title}</Typography>
          <Typography variant="body2" color="text.secondary">
            {attr.definition}
          </Typography>
        </Stack>
      </AccordionSummary>
      <AccordionDetails>
        <Stack spacing={1.25}>
          <Stack direction="row" spacing={1} justifyContent="flex-end" flexWrap="wrap">
            <Button
              size="small"
              startIcon={<PsychologyIcon />}
              onClick={() =>
                onAskAI({
                  type: "attribute",
                  subcat: sc,
                  level,
                  attributeId: attr.id,
                  title: attr.title,
                })
              }
            >
              AI Assist
            </Button>
            <Button size="small" startIcon={<EditIcon />}>
              Edit
            </Button>
          </Stack>

          <Box>
            <Typography variant="subtitle2" sx={{ mb: 0.5 }}>
              Artifacts
            </Typography>
            <List dense>
              {artifacts.map((a) => (
                <ListItemButton key={a.id} component="a" href={a.url} target="_blank">
                  <ListItemText primary={a.title} secondary={a.url} />
                </ListItemButton>
              ))}
            </List>
            {adding ? (
              <Stack direction={{ xs: "column", sm: "row" }} spacing={1} sx={{ mt: 1 }}>
                <TextField
                  size="small"
                  label="Title"
                  value={newTitle}
                  onChange={(e) => setNewTitle(e.target.value)}
                />
                <TextField
                  size="small"
                  label="URL"
                  value={newUrl}
                  onChange={(e) => setNewUrl(e.target.value)}
                />
                <Button
                  size="small"
                  variant="contained"
                  startIcon={<AddLinkIcon />}
                  onClick={() => {
                    if (newTitle && newUrl) {
                      onAddArtifact({ title: newTitle, url: newUrl });
                      setNewTitle("");
                      setNewUrl("");
                      setAdding(false);
                    }
                  }}
                >
                  Add
                </Button>
                <IconButton size="small" onClick={() => setAdding(false)}>
                  <CloseIcon fontSize="inherit" />
                </IconButton>
              </Stack>
            ) : (
              <Button
                size="small"
                startIcon={<AddLinkIcon />}
                onClick={() => setAdding(true)}
                sx={{ mt: 0.5 }}
              >
                Add Artifact
              </Button>
            )}
          </Box>

          <TextField
            label="Commentary"
            placeholder="Assessor-facing comment…"
            fullWidth
            size="small"
            multiline
            minRows={3}
            value={comment || ""}
            onChange={(e) => onChangeComment(e.target.value)}
          />
        </Stack>
      </AccordionDetails>
    </Accordion>
  );
}

// ===================== MAIN APP =====================
export default function App() {
  // Narrative state
  const [org, setOrg] = useState("VCS");
  const [subcats, setSubcats] = useState(["GV.RR-01", "DE.AE-02", "DE.AE-03"]);
  const [execSum, setExecSum] = useState("");
  const [scope, setScope] = useState("");
  const [quant, setQuant] = useState(false);
  const [coverage, setCoverage] = useState("");
  const [pct, setPct] = useState(85);
  const [levelTab, setLevelTab] = useState("L3");

  // Comments & artifacts per attribute
  // key = `${sc}|${level}|${attr.id}`
  const [comments, setComments] = useState({});
  const [artifactMap, setArtifactMap] = useState(() => {
    const init = {};
    DB.subcategories.forEach((sc) => {
      ["L3", "L4"].forEach((lvl) => {
        MATURITY[sc][lvl].forEach((a) => {
          const k = `${sc}|${lvl}|${a.id}`;
          init[k] = a.artifacts;
        });
      });
    });
    return init;
  });

  // AI panel state (always visible in right pane)
  const [aiVisible, setAiVisible] = useState(true);
  const [aiAgent, setAiAgent] = useState("Narrative Coach");
  const [aiPrompt, setAiPrompt] = useState("");
  const [aiBusy, setAiBusy] = useState(false);
  const [aiTab, setAiTab] = useState(0); // 0=Chat, 1=Audit
  const [history, setHistory] = useState([]); // {id, role, text, score?, agent?, usage?, target?}
  const [audit, setAudit] = useState([]); // {id, timestamp, appliedTo, text}

  // Resizable split
  const [panePct, setPanePct] = useState(() => {
    const v = Number(localStorage.getItem("panePctV2") || 60);
    return Math.min(75, Math.max(35, v));
  });
  const containerRef = useRef(null);
  const startDrag = (e) => {
    if (!containerRef.current) return;
    const startX = e.clientX;
    const rect = containerRef.current.getBoundingClientRect();
    const startPct = panePct;
    const onMove = (ev) => {
      const pct = Math.min(75, Math.max(35, startPct + ((ev.clientX - startX) / rect.width) * 100));
      setPanePct(pct);
    };
    const onUp = () => {
      window.removeEventListener("mousemove", onMove);
      window.removeEventListener("mouseup", onUp);
      localStorage.setItem("panePctV2", String(panePct));
    };
    window.addEventListener("mousemove", onMove);
    window.addEventListener("mouseup", onUp);
  };

  // Narrative string for export/preview
  const narrative = useMemo(() => {
    const lines = [];
    lines.push(`# Narrative for ${org}`);
    if (execSum) lines.push("", `**Executive Summary**\n${execSum}`);
    if (scope) lines.push("", `**Scope**\n${scope}`);
    if (quant) lines.push("", `**Coverage / Profile (Quantitative)**\nAssessed population coverage: ~${pct}%.`);
    else if (coverage) lines.push("", `**Coverage / Profile (Qualitative)**\n${coverage}`);
    lines.push("");
    subcats.forEach((sc) => {
      lines.push(`## ${sc}: ${DEFINITIONS[sc]}`);
      ["L3", "L4"].forEach((lvl) => {
        lines.push(`**Maturity ${lvl.replace("L", "Level ")}:**`);
        MATURITY[sc][lvl].forEach((a) => {
          const key = `${sc}|${lvl}|${a.id}`;
          const arts = (artifactMap[key] || []).map((x) => x.title).join(", ");
          lines.push(`- *${a.title}:* ${a.definition}`);
          if (comments[key]) lines.push(`  - **Comment:** ${comments[key]}`);
          lines.push(`  - **Artifacts:** ${arts}`);
        });
        lines.push("");
      });
    });
    return lines.join("\n");
  }, [org, subcats, execSum, scope, quant, coverage, pct, comments, artifactMap]);

  // Export helpers (kept lightweight)
  async function exportPDF() {
    const { jsPDF } = await import("jspdf");
    const doc = new jsPDF({ unit: "pt", format: "a4" });
    const margin = 40;
    const maxWidth = 515;
    const text = narrative.replaceAll("\n", "\n\n");
    const lines = doc.splitTextToSize(text, maxWidth);
    doc.text(lines, margin, margin);
    doc.save(`Narrative_${org}.pdf`);
  }
  async function exportDocx() {
    const docx = await import("docx");
    const { Document, Packer, Paragraph, TextRun, HeadingLevel } = docx;
    const blocks = [];
    blocks.push(
      new Paragraph({ heading: HeadingLevel.TITLE, children: [new TextRun(`Narrative for ${org}`)] })
    );
    narrative.split("\n").forEach((line) => {
      if (!line.trim()) {
        blocks.push(new Paragraph(""));
        return;
      }
      if (line.startsWith("## ")) {
        blocks.push(
          new Paragraph({
            heading: HeadingLevel.HEADING_2,
            children: [new TextRun(line.replace("## ", ""))],
          })
        );
      } else if (line.startsWith("**") && line.endsWith("**")) {
        blocks.push(
          new Paragraph({
            heading: HeadingLevel.HEADING_3,
            children: [new TextRun(line.replaceAll("**", ""))],
          })
        );
      } else {
        blocks.push(new Paragraph({ children: [new TextRun(line.replaceAll("**", ""))] }));
      }
    });
    const doc = new Document({ sections: [{ children: blocks }] });
    const blob = await Packer.toBlob(doc);
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `Narrative_${org}.docx`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // ---- AI actions ----
  const runAI = async (prompt, target) => {
    if (!prompt || !prompt.trim()) return;
    setAiBusy(true);
    const userMsg = { id: crypto.randomUUID(), role: "user", text: prompt, target };
    setHistory((h) => [...h, userMsg]);

    const res = await callAgentAPI({ agent: aiAgent, prompt, target });
    const assistantMsg = {
      id: crypto.randomUUID(),
      role: "assistant",
      agent: res.agent,
      score: res.score,
      usage: res.usage,
      text: res.text,
      target,
    };
    setHistory((h) => [...h, assistantMsg]);
    setAiBusy(false);
    setAiTab(0);
  };

  const applySuggestion = (msg, destination) => {
    if (!msg?.text) return;
    if (destination === "exec") setExecSum((v) => (v ? v + "\n\n" : "") + msg.text);
    else if (destination === "scope") setScope((v) => (v ? v + "\n\n" : "") + msg.text);
    else if (destination && destination.type === "attribute") {
      const { subcat, level, attributeId } = destination;
      const key = `${subcat}|${level}|${attributeId}`;
      setComments((c) => ({
        ...c,
        [key]: (c[key] ? c[key] + "\n\n" : "") + msg.text,
      }));
    }
    setAudit((a) => [
      ...a,
      {
        id: crypto.randomUUID(),
        timestamp: new Date().toISOString(),
        appliedTo:
          destination === "exec"
            ? "Executive Summary"
            : destination === "scope"
            ? "Scope"
            : `Attribute ${destination?.subcat} ${destination?.level} ${destination?.attributeId}`,
        text: msg.text,
      },
    ]);
  };

  const clearChat = () => setHistory([]);

  // ---------- UI ----------
  const RightPane = (
    <Card variant="outlined" sx={{ height: "100%" }}>
      <CardContent sx={{ display: "flex", flexDirection: "column", gap: 1, height: "100%" }}>
        <Stack direction="row" spacing={1} alignItems="center">
          <Avatar>
            <PsychologyIcon />
          </Avatar>
          <Box>
            <Typography variant="h6">AI Assist</Typography>
            <Typography variant="caption" color="text.secondary">
              Pick agent · Ask · Apply · Audit
            </Typography>
          </Box>
          <Box sx={{ flex: 1 }} />
          <Button size="small" variant="text" onClick={() => setAiVisible(false)}>
            Hide
          </Button>
        </Stack>

        <FormControl fullWidth size="small">
          <InputLabel id="agent-label">Agent</InputLabel>
          <Select
            labelId="agent-label"
            value={aiAgent}
            label="Agent"
            onChange={(e) => setAiAgent(e.target.value)}
          >
            <MenuItem value="Narrative Coach">Narrative Coach</MenuItem>
            <MenuItem value="Artifact Mapper">Artifact Mapper</MenuItem>
            <MenuItem value="Coverage Estimator">Coverage Estimator</MenuItem>
          </Select>
        </FormControl>

        <Tabs value={aiTab} onChange={(_, v) => setAiTab(v)}>
          <Tab label="Chat" />
          <Tab label="Audit" />
        </Tabs>

        {aiTab === 0 ? (
          <React.Fragment>
            {/* Composer */}
            <Stack direction="row" spacing={1}>
              <TextField
                placeholder="Ask the agent…"
                fullWidth
                size="small"
                value={aiPrompt}
                onChange={(e) => setAiPrompt(e.target.value)}
                onKeyDown={(e) => {
                  if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    runAI(aiPrompt);
                    setAiPrompt("");
                  }
                }}
              />
              <Button
                startIcon={<SendIcon />}
                variant="contained"
                onClick={() => {
                  runAI(aiPrompt);
                  setAiPrompt("");
                }}
              >
                Send
              </Button>
              <IconButton title="Clear chat" onClick={clearChat}>
                <ClearAllIcon />
              </IconButton>
            </Stack>

            {/* History */}
            <Paper variant="outlined" sx={{ p: 1, flex: 1, overflow: "auto", minHeight: 240 }}>
              <Stack spacing={1}>
                {history.length === 0 && (
                  <Typography variant="body2" color="text.secondary">
                    No conversation yet. Use “Enrich with AI” on the left, or ask a question here.
                  </Typography>
                )}
                {history.map((m) => (
                  <Box key={m.id} sx={{ display: "flex", gap: 1, alignItems: "flex-start" }}>
                    {m.role === "assistant" ? (
                      <Avatar sx={{ bgcolor: "primary.main" }}>
                        <PsychologyIcon fontSize="small" />
                      </Avatar>
                    ) : (
                      <Avatar>U</Avatar>
                    )}
                    <Box sx={{ flex: 1 }}>
                      <Stack direction="row" spacing={1} alignItems="center" sx={{ mb: 0.5 }}>
                        <Typography variant="subtitle2">
                          {m.role === "assistant" ? m.agent || "Assistant" : "You"}
                        </Typography>
                        {m.role === "assistant" && (
                          <Chip
                            size="small"
                            label={`Confidence ${m.score ?? 0}%`}
                            color={
                              m.score >= 85 ? "success" : m.score >= 75 ? "warning" : "default"
                            }
                          />
                        )}
                      </Stack>
                      <Typography variant="body2" sx={{ whiteSpace: "pre-wrap" }}>
                        {m.text}
                      </Typography>

                      {/* Apply actions */}
                      {m.role === "assistant" && (
                        <Stack direction="row" spacing={1} sx={{ mt: 0.5 }} useFlexGap flexWrap="wrap">
                          <Button
                            size="small"
                            startIcon={<TaskAltIcon fontSize="inherit" />}
                            onClick={() => applySuggestion(m, "exec")}
                          >
                            Apply to Exec Summary
                          </Button>
                          <Button size="small" onClick={() => applySuggestion(m, "scope")}>
                            Apply to Scope
                          </Button>
                          {m.target?.type === "attribute" && (
                            <Button
                              size="small"
                              onClick={() => applySuggestion(m, m.target)}
                            >
                              Apply to Attribute Comment
                            </Button>
                          )}
                          <IconButton
                            size="small"
                            title="Copy"
                            onClick={() => navigator.clipboard.writeText(m.text)}
                          >
                            <ContentCopyIcon fontSize="inherit" />
                          </IconButton>
                        </Stack>
                      )}
                    </Box>
                  </Box>
                ))}
                {aiBusy && (
                  <Box>
                    <Typography variant="body2">Thinking…</Typography>
                    <LinearProgress sx={{ my: 1 }} />
                  </Box>
                )}
              </Stack>
            </Paper>
          </React.Fragment>
        ) : (
          // Audit tab
          <Paper variant="outlined" sx={{ p: 1, flex: 1, overflow: "auto", minHeight: 240 }}>
            <Stack spacing={1}>
              {audit.length === 0 && (
                <Typography variant="body2" color="text.secondary">
                  No applied AI changes yet.
                </Typography>
              )}
              {audit.map((a) => (
                <Box key={a.id}>
                  <Typography variant="caption" color="text.secondary">
                    {new Date(a.timestamp).toLocaleString()}
                  </Typography>
                  <Typography variant="subtitle2">{a.appliedTo}</Typography>
                  <Typography variant="body2" sx={{ whiteSpace: "pre-wrap" }}>
                    {a.text}
                  </Typography>
                  <Divider sx={{ my: 1 }} />
                </Box>
              ))}
            </Stack>
          </Paper>
        )}
      </CardContent>
    </Card>
  );

  return (
    <React.Fragment>
      <CssBaseline />
      <Container maxWidth="lg" sx={{ py: 2 }}>
        {/* Header */}
        <Stack
          direction={{ xs: "column", md: "row" }}
          alignItems={{ md: "center" }}
          justifyContent="space-between"
          spacing={1}
          sx={{ mb: 1 }}
        >
          <Typography variant="h5">CSF 2.0 Narrative Generator</Typography>
          <Stack direction="row" spacing={1} useFlexGap flexWrap="wrap">
            <Button startIcon={<VisibilityIcon />} color="secondary" variant="outlined"
              onClick={() => alert("Preview would render the narrative text.")}
            >
              Preview
            </Button>
            <Button startIcon={<PictureAsPdfIcon />} variant="outlined" onClick={exportPDF}>
              PDF
            </Button>
            <Button startIcon={<DescriptionIcon />} variant="outlined" onClick={exportDocx}>
              DOCX
            </Button>
            {!aiVisible && (
              <Button onClick={() => setAiVisible(true)}>Show AI Assist</Button>
            )}
          </Stack>
        </Stack>

        {/* Split pane container */}
        <Box
          ref={containerRef}
          sx={{
            display: { xs: "block", md: "grid" },
            gridTemplateColumns: aiVisible
              ? { md: `${panePct}% 6px ${100 - panePct}%` }
              : { md: "100%" },
            columnGap: 0,
            mb: 2,
          }}
        >
          {/* LEFT: entire linear narrative template (including attributes) */}
          <Box>
            {/* Narrative block */}
            <Card variant="outlined" sx={{ mb: 2 }}>
              <CardContent>
                <Stack spacing={2}>
                  <Box>
                    <Typography variant="subtitle2" sx={{ mb: 0.5 }}>
                      Organization
                    </Typography>
                    <ButtonGroup fullWidth>
                      {DB.orgs.map((o) => (
                        <Button
                          key={o}
                          variant={org === o ? "contained" : "outlined"}
                          onClick={() => setOrg(o)}
                        >
                          {o}
                        </Button>
                      ))}
                    </ButtonGroup>
                  </Box>

                  <MultiSelect
                    label="Subcategories"
                    options={DB.subcategories}
                    value={subcats}
                    onChange={setSubcats}
                  />

                  <Stack spacing={1}>
                    <Stack direction="row" alignItems="center" justifyContent="space-between">
                      <Typography variant="subtitle2">Executive Summary</Typography>
                      <Button
                        size="small"
                        onClick={() =>
                          runAI(
                            "Draft an executive summary highlighting L3→L4 roadmap and KPIs."
                          )
                        }
                      >
                        Enrich with AI
                      </Button>
                    </Stack>
                    <TextField
                      value={execSum}
                      onChange={(e) => setExecSum(e.target.value)}
                      multiline
                      minRows={3}
                      fullWidth
                      placeholder="Exec summary…"
                    />
                  </Stack>

                  <Stack spacing={1}>
                    <Stack direction="row" alignItems="center" justifyContent="space-between">
                      <Typography variant="subtitle2">Scope</Typography>
                      <Button size="small" onClick={() => runAI("Draft a concise scope statement.")}>
                        Enrich with AI
                      </Button>
                    </Stack>
                    <TextField
                      value={scope}
                      onChange={(e) => setScope(e.target.value)}
                      multiline
                      minRows={2}
                      fullWidth
                      placeholder="Scope…"
                    />
                  </Stack>

                  <Box>
                    <FormControlLabel
                      control={
                        <Switch
                          checked={quant}
                          onChange={(e) => setQuant(e.target.checked)}
                        />
                      }
                      label={quant ? "Quantitative" : "Qualitative"}
                    />
                    {!quant ? (
                      <TextField
                        value={coverage}
                        onChange={(e) => setCoverage(e.target.value)}
                        fullWidth
                        placeholder="Qualitative coverage…"
                      />
                    ) : (
                      <TextField
                        label="Coverage %"
                        type="number"
                        inputProps={{ min: 0, max: 100 }}
                        value={pct}
                        onChange={(e) => setPct(Number(e.target.value))}
                        sx={{ width: 160 }}
                      />
                    )}
                  </Box>
                </Stack>
              </CardContent>
            </Card>

            {/* Attributes (full linear, like your screenshot) */}
            <Card variant="outlined">
              <CardContent>
                <Tabs
                  value={levelTab}
                  onChange={(_, v) => setLevelTab(v)}
                  variant="scrollable"
                  aria-label="maturity tabs"
                >
                  <Tab label="Level 3" value="L3" />
                  <Tab label="Level 4" value="L4" />
                </Tabs>
                <Divider sx={{ my: 1 }} />
                <Stack spacing={1.25}>
                  {subcats.map((sc) => (
                    <Box key={sc}>
                      <Typography variant="h6" sx={{ mb: 0.5 }}>
                        {sc}: {DEFINITIONS[sc]}
                      </Typography>
                      <Stack spacing={1}>
                        {MATURITY[sc][levelTab].map((attr) => {
                          const key = `${sc}|${levelTab}|${attr.id}`;
                          return (
                            <AttributeBlock
                              key={key}
                              sc={sc}
                              level={levelTab}
                              attr={attr}
                              comment={comments[key]}
                              artifacts={artifactMap[key] || []}
                              onChangeComment={(val) =>
                                setComments((c) => ({ ...c, [key]: val }))
                              }
                              onAddArtifact={(item) =>
                                setArtifactMap((m) => ({
                                  ...m,
                                  [key]: [...(m[key] || []), { id: crypto.randomUUID(), ...item }],
                                }))
                              }
                              onEditArtifact={() => {}}
                              onAskAI={(target) =>
                                runAI(
                                  `Draft an evidence-based comment for ${target.subcat} ${target.level} (${attr.title}).`,
                                  target
                                )
                              }
                            />
                          );
                        })}
                      </Stack>
                    </Box>
                  ))}
                </Stack>
              </CardContent>
            </Card>
          </Box>

          {/* Resizer */}
          {aiVisible && (
            <Box
              role="separator"
              aria-label="Resize panes"
              onMouseDown={startDrag}
              sx={{
                display: { xs: "none", md: "block" },
                cursor: "col-resize",
                bgcolor: "divider",
                "&:hover": { bgcolor: "primary.main" },
                width: 6,
              }}
            />
          )}

          {/* RIGHT: AI Assist panel */}
          {aiVisible && <Box>{RightPane}</Box>}
        </Box>
      </Container>
    </React.Fragment>
  );
}
