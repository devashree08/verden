# Smoke: Auth policy

## Goal
Verify JWT validation, email extraction, and that tools run **only** with the token’s `email`.

## Pre-reqs
- Server running locally:
  ```bash
  uv run python -m framework.core.bootstrap
  ```
- Valid Keycloak JWT for a test user (e.g., `alice@alice.com`).

## Cases

### 1) No token → 401/unauthorized
- Open MCP Inspector → connect to `http://localhost:8080/mcp/` **without** `Authorization` header.
- Expected: connection rejected or listing fails with unauthorized.

### 2) Invalid issuer/audience → 401
- Use a token with wrong `iss` or `aud`.
- Expected: 401 with a clear auth error (check server log).

### 3) Valid token → tools/resources list
- Connect with `Authorization: Bearer <JWT>` (valid `iss/aud/exp/nbf`).
- Expected: tools `get_*` appear; resource template `fields://{tool_name}` appears; prompts appear.

### 4) Email propagation (policy)
- Call any tool with **no `email` param** (we don’t accept an email input).
- Expected: tool runs; server logs show hashed email; results scoped to that caller.
- Quick check: `row_count` logs, no PII/token in logs.

### 5) Resource fetch
- Resources → fetch `fields://get_vast_general_by_user`.
- Expected: JSON with `fields` and `_meta`, no YAML parse errors.
