CREATE OR ALTER PROC dbo.usp_PortalPolicies_GetForUser
    @UserEID    NVARCHAR(64)  = NULL,
    @UserName   NVARCHAR(256) = NULL
AS
BEGIN
    SET NOCOUNT ON;

    IF @UserEID IS NULL AND @UserName IS NULL
        THROW 50071, 'Either @UserEID or @UserName is required.', 1;

    ;WITH m AS (
        SELECT *
        FROM dbo.AdGroupFeed
        WHERE
            (@UserEID IS NOT NULL AND UserEID = @UserEID)
            OR (
                @UserEID IS NULL AND @UserName IS NOT NULL
                AND UPPER(LTRIM(RTRIM(UserName))) = UPPER(LTRIM(RTRIM(@UserName)))
            )
    ),
    admin_flag AS (
        SELECT CASE WHEN EXISTS (
                   SELECT 1 FROM m
                   WHERE UPPER(GroupName) = 'CYBER_PORTAL_ADMINS'
               ) THEN 1 ELSE 0 END AS IsAdmin
    ),
    org_memberships AS (
        SELECT DISTINCT om.OrgId, om.OrgCode
        FROM m
        JOIN dbo.Portal_OrgMap om
          ON om.GroupNameLike IS NOT NULL
         AND UPPER(m.GroupName) LIKE UPPER(om.GroupNameLike)
    ),
    any_membership AS (
        SELECT CASE WHEN EXISTS (SELECT 1 FROM org_memberships) THEN 1 ELSE 0 END AS HasAny
    )
    SELECT PolicyName
    FROM (
        -- Baseline: PortalUser if in any mapped org or an admin
        SELECT 'PortalUser' AS PolicyName, 1 AS keep
        FROM any_membership a
        CROSS JOIN admin_flag f
        WHERE a.HasAny = 1 OR f.IsAdmin = 1

        UNION ALL
        -- Admin
        SELECT 'Admin', 1
        FROM admin_flag
        WHERE IsAdmin = 1

        UNION ALL
        -- Admins get all org Edit policies
        SELECT 'Edit.' + om.OrgCode + '.All', 1
        FROM admin_flag f
        JOIN dbo.Portal_OrgMap om
          ON f.IsAdmin = 1

        UNION ALL
        -- Members get their own org Edit policies
        SELECT 'Edit.' + om.OrgCode + '.All', 1
        FROM org_memberships om
    ) x
    WHERE keep = 1
    GROUP BY PolicyName
    ORDER BY PolicyName;
END
GO

