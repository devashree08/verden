-- 1) Clear target table
TRUNCATE TABLE dbo.owner_mapping;
GO

-- 2) Insert from dbo.analysis (Owner/Custodian), splitting names, normalizing subcat, joining org & ref tables
WITH A AS (
    SELECT
        a.BU,
        a._2_0_subcategory,
        a.[_2025_Owner],
        a.[_2025_Custodian]
    FROM dbo.analysis AS a
),
-- Unpivot Owner/Custodian into rows
Roles AS (
    SELECT
        BU,
        _2_0_subcategory,
        RoleName,
        NameList
    FROM A
    CROSS APPLY (VALUES
        ('Owner',     [_2025_Owner]),
        ('Custodian', [_2025_Custodian])
    ) v(RoleName, NameList)
    WHERE NameList IS NOT NULL AND LTRIM(RTRIM(CONVERT(varchar(max), NameList))) <> ''
),
-- Split comma-separated names into one row per person; trim whitespace
SplitNames AS (
    SELECT
        r.BU,
        r._2_0_subcategory,
        r.RoleName AS ContactRole,
        LTRIM(RTRIM(s.value)) AS FullName
    FROM Roles r
    CROSS APPLY STRING_SPLIT(CONVERT(varchar(max), r.NameList), ',') AS s
    WHERE LTRIM(RTRIM(s.value)) <> ''
),
-- Normalize subcategory: pad single-digit suffix after the last '-' with a leading zero.
-- 'DE.AE-2'  -> 'DE.AE-02'
-- 'DE.AE-10' -> unchanged
NormSubcat AS (
    SELECT
        sn.BU,
        sn._2_0_subcategory,
        sn.ContactRole,
        sn.FullName,
        CASE
            WHEN CHARINDEX('-', sn._2_0_subcategory) > 0 THEN
                CASE
                    WHEN LEN(RIGHT(sn._2_0_subcategory, CHARINDEX('-', REVERSE(sn._2_0_subcategory)) - 1)) = 1
                        THEN CONCAT(
                            LEFT(sn._2_0_subcategory,
                                 LEN(sn._2_0_subcategory) - (CHARINDEX('-', REVERSE(sn._2_0_subcategory)))),
                            '-0',
                            RIGHT(sn._2_0_subcategory, CHARINDEX('-', REVERSE(sn._2_0_subcategory)) - 1)
                        )
                    ELSE sn._2_0_subcategory
                END
            ELSE sn._2_0_subcategory
        END AS SubcatName_Normalized
    FROM SplitNames sn
),
-- Join to Org and Subcat lookup tables
Joined AS (
    SELECT DISTINCT
        ol.OrgID,
        rs.SubcatID AS CSF_2_0_SubacatID,
        n.FullName,
        n.ContactRole
    FROM NormSubcat n
    INNER JOIN dbo.orglist      AS ol ON ol.OrgAbbr    = n.BU
    INNER JOIN ref.CSF2_Subcat  AS rs ON rs.subcatName = n.SubcatName_Normalized
)
INSERT INTO dbo.owner_mapping
(
    OrgID,
    CSF_2_0_SubacatID,
    PZID,
    FullName,
    ContactEmail,
    ContactRole,
    Eff_Dt,
    Exp_Dt,
    Status
)
SELECT
    j.OrgID,
    j.CSF_2_0_SubacatID,
    NULL                               AS PZID,
    j.FullName,
    NULL                               AS ContactEmail,
    j.ContactRole,
    CAST('2025-08-01' AS date)         AS Eff_Dt,
    CAST('2028-12-01' AS date)         AS Exp_Dt,
    'A'                                AS Status
FROM Joined j;
GO
