"""
Tool: get_all_apps_value_by_user  -> dbo.SPGetAllAppsValueByUser
- Current-month, daily snapshot
- Optional VAST filter (CSV or list)
- Pydantic validation & normalization for inputs
"""

from __future__ import annotations
from typing import Any, Dict, List, Optional, Union

from fastmcp import Context
from pydantic import BaseModel, Field, field_validator

from framework.core.registry import mcp
from framework.core.config import DB_BACKEND
from framework.schemas.outputs import ROWS_OUTPUT


class _WithPaging(BaseModel):
    limit: int = Field(
        default=1000,
        description="Max rows to return (1â€“15000).",
        ge=1,
        le=15000,
        examples=[100, 1000, 5000],
    )
    offset: int = Field(
        default=0,
        description="Row offset for pagination (>= 0).",
        ge=0,
        examples=[0, 100, 1000],
    )

    @field_validator("limit")
    @classmethod
    def cap_limit(cls, v: int) -> int:
        return max(1, min(v, 15_000))

    @field_validator("offset")
    @classmethod
    def non_negative_offset(cls, v: int) -> int:
        return max(0, v)


class AllAppsValueParams(_WithPaging):
    vast: Optional[Union[str, List[Union[int, str]]]] = Field(
        default=None,
        description="VAST IDs to filter. Accepts CSV string ('101,202') or array (['101','202']). Omit for all allowed VASTs.",
        examples=["101,202", ["101", "202"]],
    )

    @field_validator("vast", mode="before")
    @classmethod
    def normalize_vast(cls, v: Any) -> Optional[str]:
        if v is None:
            return None
        if isinstance(v, str):
            s = v.strip()
            return s or None
        if isinstance(v, (list, tuple)):
            parts: List[str] = []
            for item in v:
                if item is None:
                    continue
                s = str(item).strip()
                if s:
                    parts.append(s)
            return ",".join(parts) or None
        s = str(v).strip()
        return s or None


@mcp.tool(
    name="get_all_apps_value_by_user",
    description=(
        "Return current-month application vulnerability counts for the caller's accessible VASTs. "
        "Optionally filter by VAST IDs."
    ),
    output_schema=ROWS_OUTPUT,
)
async def get_all_apps_value_by_user(
    params: AllAppsValueParams,
    ctx: Context,
) -> Dict[str, List[Dict[str, Any]]]:
    email = (ctx.get_state("email") or "").lower()

    if DB_BACKEND == "mssql":
        from framework.adapters.mssql import call_sp_allapps_value as run_query
        rows = run_query(email=email, vast=params.vast, limit=params.limit, offset=params.offset)
    else:
        from framework.adapters.bigquery import query_allapps_value as run_query
        rows = run_query(email=email, vast=params.vast, limit=params.limit, offset=params.offset)

    return {"rows": rows}

