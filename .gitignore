"""
Tool: get_vast_general_by_user  -> dbo.SPGetVastGeneralByUser
- General/compliance data for VASTs (includes decommissioned)
"""

from __future__ import annotations
from typing import Any, Dict, List, Optional, Union

from fastmcp import Context
from framework.core.registry import mcp
from framework.core.config import DB_BACKEND
from framework.schemas.inputs import GET_VAST_GENERAL_BY_USER
from framework.schemas.outputs import ROWS_OUTPUT


@mcp.tool(
    name="get_vast_general_by_user",
    description=(
        "Return general/compliance attributes (SOX, PCI, rankings, etc.) "
        "for the caller's accessible VASTs. Includes decommissioned."
    ),
    input_schema=GET_VAST_GENERAL_BY_USER,
    output_schema=ROWS_OUTPUT,
)
async def get_vast_general_by_user(
    vast: Optional[Union[str, List[Union[int, str]]]] = None,
    limit: int = 1000,
    offset: int = 0,
    ctx: Context = Context.depends(),
) -> Dict[str, List[Dict[str, Any]]]:
    email = (ctx.get_state("email") or "").lower()

    if DB_BACKEND == "mssql":
        from framework.adapters.mssql import call_sp_vast_general as run_query
        rows = run_query(email=email, vast=vast, limit=limit, offset=offset)
    else:
        from framework.adapters.bigquery import query_vast_general as run_query
        rows = run_query(email=email, vast=vast, limit=limit, offset=offset)

    return {"rows": rows}
