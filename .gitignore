# framework/auth/oidc.py

from __future__ import annotations
import logging
from typing import Optional

from fastmcp.server.auth.providers.jwt import JWTVerifier
from fastmcp.server.middleware import Middleware, MiddlewareContext
from fastmcp.server.dependencies import get_access_token

from ..core.config import (
    OIDC_JWKS_URI,
    OIDC_ISSUER_URI,
    OIDC_ALLOWED_AUDIENCE,
)

log = logging.getLogger(__name__)


def build_jwt_verifier() -> JWTVerifier:
    if not (OIDC_JWKS_URI and OIDC_ISSUER_URI and OIDC_ALLOWED_AUDIENCE):
        raise RuntimeError(
            "JWT auth misconfigured: OIDC_JWKS_URI, OIDC_ISSUER_URI, and OIDC_ALLOWED_AUDIENCE are required"
        )
    return JWTVerifier(
        jwks_uri=OIDC_JWKS_URI,
        issuer=OIDC_ISSUER_URI,
        audience=OIDC_ALLOWED_AUDIENCE,
    )


class EmailClaimMiddleware(Middleware):
    """Extract caller email from verified JWT and stash in request state."""

    async def on_request(self, context: MiddlewareContext, call_next):
        token = get_access_token()
        if token is None:
            return await context.fastmcp_context.error("Unauthorized: missing or invalid access token", status=401)

        claims = token.claims or {}
        raw_email: Optional[str] = (
            claims.get("email")
            or claims.get("upn")
            or claims.get("preferred_username")
        )
        if not raw_email:
            return await context.fastmcp_context.error("Forbidden: email claim missing", status=403)

        # Put normalized email into FastMCP Context state for tools
        context.fastmcp_context.set_state("email", raw_email.strip().lower())

        # IMPORTANT: pass the context along
        return await call_next(context)
