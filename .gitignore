-- One row = one link attached to one attribute row (baseline or custom)
CREATE TABLE dbo.AttributeArtifact (
  ArtifactLinkID       INT IDENTITY(1,1) PRIMARY KEY,
  OrgID                INT                NOT NULL,
  CSF2SubcategoryID    INT                NOT NULL,
  MaturityLevel        INT                NOT NULL,
  CSF1SubcategoryID    INT                NULL,  -- baseline only; NULL for custom
  AttributeNum         INT                NULL,  -- baseline only; NULL for custom
  CustomAttributeNum   INT                NULL,  -- custom only; NULL for baseline

  Url                  NVARCHAR(2048)     NOT NULL,
  Title                NVARCHAR(300)      NULL,

  IsActive             BIT                NOT NULL CONSTRAINT DF_AttributeArtifact_IsActive DEFAULT (1),
  CreatedBy            NVARCHAR(200)      NULL,
  CreatedAt            DATETIME2(0)       NOT NULL CONSTRAINT DF_AttributeArtifact_CreatedAt DEFAULT (SYSUTCDATETIME()),
  UpdatedAt            DATETIME2(0)       NULL
);
GO

/* Enforce “no duplicate link for the same attribute” (baseline vs custom) */

-- Baseline attributes: unique per (org, subcat, ml, csf1, attrNum, url)
CREATE UNIQUE INDEX UX_AttributeArtifact_Baseline
ON dbo.AttributeArtifact(OrgID, CSF2SubcategoryID, MaturityLevel, CSF1SubcategoryID, AttributeNum, Url)
WHERE IsActive = 1 AND CustomAttributeNum IS NULL;

-- Custom attributes: unique per (org, subcat, ml, customAttrNum, url)
CREATE UNIQUE INDEX UX_AttributeArtifact_Custom
ON dbo.AttributeArtifact(OrgID, CSF2SubcategoryID, MaturityLevel, CustomAttributeNum, Url)
WHERE IsActive = 1 AND CustomAttributeNum IS NOT NULL;

-- Fast lookups for “reuse pool” within org+subcat
CREATE INDEX IX_AttributeArtifact_OrgSubcat_Active
ON dbo.AttributeArtifact(OrgID, CSF2SubcategoryID, IsActive)
INCLUDE (Url, Title, MaturityLevel, CSF1SubcategoryID, AttributeNum, CustomAttributeNum, CreatedAt);
GO
